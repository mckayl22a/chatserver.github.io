<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GurtChat - Login</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="login-container">
    <h1>Welcome to GurtChat</h1>

    <div id="auth-forms">
      <!-- Login Form -->
      <div id="login-form">
        <input type="email" id="login-email" placeholder="Email" required />
        <input type="password" id="login-password" placeholder="Password" required />
        <button id="login-btn">Login</button>
        <p>Don’t have an account? <a href="#" id="show-register">Create one</a></p>
      </div>

      <!-- Register Form -->
      <div id="register-form" style="display:none;">
        <input type="text" id="register-username" placeholder="Username" required />
        <input type="email" id="register-email" placeholder="Email" required />
        <input type="password" id="register-password" placeholder="Password" required />
        <button id="register-btn">Create Account</button>
        <p>Already have an account? <a href="#" id="show-login">Back to login</a></p>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword, 
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { 
      getDatabase, 
      ref, 
      set, 
      get, 
      child 
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

    // ✅ Your Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAAOy6HTJ7DCg3jGqCzrvQPWVhtU9umJ0E",
      authDomain: "gurtchat-237b3.firebaseapp.com",
      databaseURL: "https://gurtchat-237b3-default-rtdb.firebaseio.com",
      projectId: "gurtchat-237b3",
      storageBucket: "gurtchat-237b3.firebasestorage.app",
      messagingSenderId: "762205720734",
      appId: "1:762205720734:web:e96c0888b31155380aeb8f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // 🔄 Switch Between Forms
    document.getElementById("show-register").addEventListener("click", () => {
      document.getElementById("login-form").style.display = "none";
      document.getElementById("register-form").style.display = "block";
    });

    document.getElementById("show-login").addEventListener("click", () => {
      document.getElementById("register-form").style.display = "none";
      document.getElementById("login-form").style.display = "block";
    });

    // ✨ Create a New Account
    document.getElementById("register-btn").addEventListener("click", async () => {
      const username = document.getElementById("register-username").value.trim();
      const email = document.getElementById("register-email").value.trim();
      const password = document.getElementById("register-password").value.trim();

      if (!username || !email || !password) {
        alert("Please fill in all fields.");
        return;
      }

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // Save user info to database
        await set(ref(db, "users/" + user.uid), {
          username: username,
          email: email,
          isAdmin: false,
          createdAt: new Date().toISOString()
        });

        // Save username to localStorage for use in chat
        localStorage.setItem("gurtchat_username", username);

        alert("Account created successfully!");
        window.location.href = "chat.html";
      } catch (error) {
        alert("Error: " + error.message);
      }
    });

    // 🔐 Login
    document.getElementById("login-btn").addEventListener("click", async () => {
      const email = document.getElementById("login-email").value.trim();
      const password = document.getElementById("login-password").value.trim();

      if (!email || !password) {
        alert("Please fill in all fields.");
        return;
      }

      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // Fetch username from database
        const userRef = ref(db);
        const snapshot = await get(child(userRef, `users/${user.uid}/username`));
        if (snapshot.exists()) {
          localStorage.setItem("gurtchat_username", snapshot.val());
        }

        window.location.href = "chat.html";
      } catch (error) {
        alert("Login failed: " + error.message);
      }
    });

    // 🚀 Auto Redirect if Already Logged In
    onAuthStateChanged(auth, (user) => {
      if (user) {
        window.location.href = "chat.html";
      }
    });
  </script>
</body>
</html>
