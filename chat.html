<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GurtChat</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="chat-wrapper">
    <!-- Sidebar -->
    <div id="sidebar">
      <h2>GurtChat</h2>
      <div class="channel-list" id="channel-list">
        <div class="channel active" data-channel="general"># general</div>
        <div class="channel" data-channel="random"># random</div>
        <div class="channel" data-channel="help"># help</div>
      </div>
      <button id="user-btn">User Page</button>
    </div>

    <!-- Chat Area -->
    <div id="chat-area">
      <div id="chat-header"># general</div>
      <div id="messages"></div>

      <div id="chat-input-area">
        <input id="chat-input" placeholder="Message #general" />
        <button id="send-btn">Send</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAAOy6HTJ7DCg3jGqCzrvQPWVhtU9umJ0E",
      authDomain: "gurtchat-237b3.firebaseapp.com",
      databaseURL: "https://gurtchat-237b3-default-rtdb.firebaseio.com",
      projectId: "gurtchat-237b3",
      storageBucket: "gurtchat-237b3.firebasestorage.app",
      messagingSenderId: "762205720734",
      appId: "1:762205720734:web:e96c0888b31155380aeb8f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentChannel = "general";
    let username = "Unknown User";

    // 🔒 Redirect if not logged in
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        username = user.email.split("@")[0];
        loadMessages(currentChannel);
      }
    });

    // 💬 Load messages for current channel
    function loadMessages(channel) {
      const messagesDiv = document.getElementById("messages");
      messagesDiv.innerHTML = "";
      const messagesRef = ref(db, `messages/${channel}`);
      onChildAdded(messagesRef, (snapshot) => {
        const msg = snapshot.val();
        const msgBubble = document.createElement("div");
        msgBubble.classList.add("msg-bubble");
        msgBubble.classList.add(msg.user === username ? "msg-user" : "msg-other");
        msgBubble.textContent = `${msg.user}: ${msg.text}`;
        messagesDiv.appendChild(msgBubble);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    }

    // 🚫 Basic bad word filter
    const badWords = ["badword1", "badword2", "offensive", "curse"];
    function filterMessage(text) {
      let clean = text;
      badWords.forEach(word => {
        const regex = new RegExp("\\b" + word + "\\b", "gi");
        clean = clean.replace(regex, "****");
      });
      return clean;
    }

    // ✉️ Send message
    document.getElementById("send-btn").addEventListener("click", sendMessage);
    document.getElementById("chat-input").addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    function sendMessage() {
      const input = document.getElementById("chat-input");
      const text = filterMessage(input.value.trim());
      if (text.length === 0) return;

      const messagesRef = ref(db, `messages/${currentChannel}`);
      push(messagesRef, {
        user: username,
        text: text,
        timestamp: Date.now()
      });
      input.value = "";
    }

    // 🔄 Switch channels
    document.querySelectorAll(".channel").forEach(el => {
      el.addEventListener("click", () => {
        document.querySelectorAll(".channel").forEach(c => c.classList.remove("active"));
        el.classList.add("active");
        currentChannel = el.dataset.channel;
        document.getElementById("chat-header").textContent = `# ${currentChannel}`;
        document.getElementById("chat-input").placeholder = `Message #${currentChannel}`;
        loadMessages(currentChannel);
      });
    });

    // 👤 Go to user page
    document.getElementById("user-btn").addEventListener("click", () => {
      window.location.href = "user.html";
    });
  </script>
</body>
</html>
