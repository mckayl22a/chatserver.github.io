<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GurtChat</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<div id="chat-wrapper">
  <!-- Sidebar -->
  <div id="sidebar">
    <h2>GurtChat</h2>
    <div class="channel-list" id="channel-list">
      <div class="channel active" data-channel="General"># General</div>
      <div class="channel" data-channel="random"># random</div>
      <div class="channel" data-channel="help"># help</div>
    </div>
    <button id="user-btn">User Page</button>
  </div>

  <!-- Chat Area -->
  <div id="chat-area">
    <div id="chat-header"># General</div>
    <div id="messages"></div>
    <div id="chat-input-area">
      <input id="chat-input" placeholder="Message #General" />
      <button id="send-btn">Send</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

const firebaseConfig = { /* same as index.html */ };
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let username = "";
let currentChannel = "General";

// Auth guard & initialize chat
onAuthStateChanged(auth, (user) => {
  if (!user) {
    localStorage.removeItem("gurtchat_username");
    window.location.href = "index.html";
    return;
  }
  username = localStorage.getItem("gurtchat_username") || user.email.split("@")[0];
  initChat();
});

function initChat() {
  const messagesDiv = document.getElementById("messages");
  const input = document.getElementById("chat-input");

  // Bad word filter
  const badWords = ["badword1","badword2"];
  function filterMessage(text) {
    badWords.forEach(w => {
      const re = new RegExp("\\b"+w+"\\b","gi");
      text = text.replace(re,"****");
    });
    return text;
  }

  // Load messages
  function loadMessages(channel) {
    messagesDiv.innerHTML = "";
    const messagesRef = ref(db, `messages/${channel}`);
    onChildAdded(messagesRef, (snapshot) => {
      const msg = snapshot.val();
      const bubble = document.createElement("div");
      bubble.classList.add("msg-bubble", msg.user === username ? "msg-user" : "msg-other");
      bubble.textContent = `${msg.user}: ${msg.text}`;
      messagesDiv.appendChild(bubble);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  }

  loadMessages(currentChannel);

  // Send message
  document.getElementById("send-btn").addEventListener("click", sendMessage);
  input.addEventListener("keypress", (e)=>{if(e.key==="Enter") sendMessage();});

  function sendMessage(){
    const text = filterMessage(input.value.trim());
    if(!text) return;
    push(ref(db, `messages/${currentChannel}`), {user: username,text: text,timestamp: Date.now()});
    input.value="";
  }

  // Switch channels
  document.querySelectorAll(".channel").forEach(el=>{
    el.addEventListener("click", ()=>{
      document.querySelectorAll(".channel").forEach(c=>c.classList.remove("active"));
      el.classList.add("active");
      currentChannel = el.dataset.channel;
      document.getElementById("chat-header").textContent = `# ${currentChannel}`;
      input.placeholder = `Message #${currentChannel}`;
      loadMessages(currentChannel);
    });
  });

  // User page button
  document.getElementById("user-btn").addEventListener("click", ()=>window.location.href="user.html");
}
</script>
</body>
</html>
