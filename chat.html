<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GurtChat - Chat</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="header">
  <h1>GurtChat</h1>
  <div class="top-buttons">
    <button id="admin-btn" style="display:none;">Admin Panel</button>
    <button id="logout-btn">Logout</button>
  </div>
</div>

<div id="app">
  <aside id="sidebar">
    <h2>Channels</h2>
    <div id="channel-list"></div>
  </aside>

  <main id="chat-area">
    <div id="messages"></div>
    <div id="input-bar">
      <input id="chat-input" placeholder="Type a message..." />
      <button id="send-btn">Send</button>
    </div>
  </main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, get, child } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAAOy6HTJ7DCg3jGqCzrvQPWVhtU9umJ0E",
  authDomain: "gurtchat-237b3.firebaseapp.com",
  databaseURL: "https://gurtchat-237b3-default-rtdb.firebaseio.com",
  projectId: "gurtchat-237b3",
  storageBucket: "gurtchat-237b3.firebasestorage.app",
  messagingSenderId: "762205720734",
  appId: "1:762205720734:web:e96c0888b31155380aeb8f"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

// Auth guard
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
  } else {
    const snap = await get(child(ref(db), `users/${user.uid}`));
    const userData = snap.val();
    if (userData?.isAdmin) {
      document.getElementById("admin-btn").style.display = "inline-block";
    }
  }
});

// Basic chat
const channels = ["General", "Random", "Dev"];
let currentChannel = "General";

const channelListDiv = document.getElementById('channel-list');
const messagesDiv = document.getElementById('messages');
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');

function renderChannels() {
  channelListDiv.innerHTML = "";
  channels.forEach(ch => {
    const btn = document.createElement("button");
    btn.textContent = ch;
    btn.className = ch === currentChannel ? "active" : "";
    btn.addEventListener("click", () => {
      currentChannel = ch;
      renderChannels();
      listenMessages();
    });
    channelListDiv.appendChild(btn);
  });
}

function renderMessage(msg) {
  const div = document.createElement("div");
  div.className = "msg-bubble";
  div.textContent = msg.user + ": " + msg.text;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function listenMessages() {
  messagesDiv.innerHTML = "";
  onChildAdded(ref(db, `messages/${currentChannel}`), (snapshot) => {
    renderMessage(snapshot.val());
  });
}

sendBtn.addEventListener("click", async () => {
  const text = chatInput.value.trim();
  if (text) {
    const user = auth.currentUser;
    const msg = { user: user.email, text, time: new Date().toLocaleTimeString() };
    push(ref(db, `messages/${currentChannel}`), msg);
    chatInput.value = "";
  }
});

document.getElementById("logout-btn").addEventListener("click", () => {
  signOut(auth).then(() => window.location.href = "index.html");
});

document.getElementById("admin-btn").addEventListener("click", () => {
  window.location.href = "admin.html";
});

renderChannels();
listenMessages();
</script>
</body>
</html>
