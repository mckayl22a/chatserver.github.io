<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GurtChat</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<div id="chat-wrapper">
  <!-- Sidebar -->
  <div id="sidebar">
    <h2>GurtChat</h2>
    <div class="channel-list" id="channel-list">
      <div class="channel active" data-channel="general"># general</div>
      <div class="channel" data-channel="random"># random</div>
      <div class="channel" data-channel="help"># help</div>
    </div>
    <button id="user-btn">User Page</button>
  </div>

  <!-- Chat Area -->
  <div id="chat-area">
    <div id="chat-header"># general</div>
    <div id="messages"></div>
    <div id="chat-input-area">
      <input id="chat-input" placeholder="Message #general" />
      <button id="send-btn">Send</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyAAOy6HTJ7DCg3jGqCzrvQPWVhtU9umJ0E",
  authDomain: "gurtchat-237b3.firebaseapp.com",
  databaseURL: "https://gurtchat-237b3-default-rtdb.firebaseio.com",
  projectId: "gurtchat-237b3",
  storageBucket: "gurtchat-237b3.firebasestorage.app",
  messagingSenderId: "762205720734",
  appId: "1:762205720734:web:e96c0888b31155380aeb8f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let username = "";
let currentChannel = "general";

onAuthStateChanged(auth, (user) => {
  if (!user) {
    // Not logged in → redirect to login page
    localStorage.removeItem("gurtchat_username");
    window.location.href = "index.html";
    return;
  }

  // User is logged in → get username
  username = localStorage.getItem("gurtchat_username") || user.email.split("@")[0];

  // Initialize chat UI after auth is confirmed
  initChatUI();
});

function initChatUI() {
  const messagesDiv = document.getElementById("messages");
  const input = document.getElementById("chat-input");

  // Bad word filter
  const badWords = ["badword1","badword2"];
  function filterMessage(text) {
    badWords.forEach(w => {
      const re = new RegExp("\\b"+w+"\\b","gi");
      text = text.replace(re,"****");
    });
    return text;
  }

  // Load messages for a channel
  function loadMessages(channel) {
    messagesDiv.innerHTML = "";
    const messagesRef = ref(db, `messages/${channel}`);
    onChildAdded(messagesRef, (snapshot) => {
      const msg = snapshot.val();
      const bubble = document.createElement("div");
      bubble.classList.add("msg-bubble", msg.user === username ? "msg-user" : "msg-other");
      bubble.textContent = `${msg.user}: ${msg.text}`;
      messagesDiv.appendChild(bubble);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  }

  loadMessages(currentChannel);

  // Send message
  function sendMessage() {
    const text = filterMessage(input.value.trim());
    if (!text) return;
    push(ref(db, `messages/${currentChannel}`), {
      user: username,
      text: text,
      timestamp: Date.now()
    });
    input.value = "";
  }

  document.getElementById("send-btn").addEventListener("click", sendMessage);
  input.addEventListener("keypress", (e) => {
    if (e.key === "Enter") sendMessage();
  });

  // Channel switching
  document.querySelectorAll(".channel").forEach(el => {
    el.addEventListener("click", () => {
      document.querySelectorAll(".channel").forEach(c => c.classList.remove("active"));
      el.classList.add("active");
      currentChannel = el.dataset.channel;
      document.getElementById("chat-header").textContent = `# ${currentChannel}`;
      input.placeholder = `Message #${currentChannel}`;
      loadMessages(currentChannel);
    });
  });

  // ✅ User Page button works now
  document.getElementById("user-btn").addEventListener("click", () => {
    window.location.href = "user.html";
  });
}
</script>
</body>
</html>
